$def with(settings, station_names, master_station_indexes)

$var title: $_('SIP Pressure-Guard Plugin')
$var page: pressure_guard_plugin  
<!DOCTYPE html>
<html>
<head>
    <title>Pressure Guard Plugin</title>
    <style>
        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1em;
        }
        .code-font {
            font-family: monospace;
        }
        .pressure-guard.station-name
        {
            text-align: right;
        }
        fieldset {
            margin-bottom: 2em;
            border: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        td, th {
            padding: 0.5em;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="top-row">
        <h2>Master Guard</h2>
        <div class="code-font" id="pressureDisplay">Last updated: --</div>
    </div>

    <fieldset>
        <legend>MQTT Topics</legend>
        <table>
            <tr>
                <td>Subscribe to:</td>
                <td><input type="text" id="subscribeTopic" ></td>
            </tr>
        <tr>
            <td>Publish to:</td>
            <td>
                <input type="text" id="publishTopic">
                <button onclick="publishMessage()">Publish</button>
        </td>
        </tr>
        </table>
    </fieldset>

    <fieldset>
        <legend>Master Stations</legend>
        <table>
            <tr>
                <th>Station</th>
                <th>Block</th>
            </tr>
            $for i, name in enumerate(station_names):
                $if (i + 1) in master_station_indexes:
                    <tr><td class="pressure-guard station-name">$name</td><td>
                        <select id="op_$master_station_indexes[i]">
                            $for op in ['<', '>', '=', '!=', '<=', '>=']:
                                <option value="$op">$op</option>
                        </select>
                        <input type="text" id="val_$master_station_indexes[i]" size="4" >                        
                        </td>
                    </tr>
        </table>
    </fieldset>
    <button onclick="saveAllSettings()">Save Settings</button>


    <div id="modal" style="display:none; position:fixed; top:30%; left:30%; background:#fff; padding:1em; border:1px solid #000;">
        <p id="modalMessage"></p>
        <button onclick="document.getElementById('modal').style.display='none'">Close</button>
    </div>

    <script>
        let master_station_indexes = JSON.parse('$:master_station_indexes');
        let settings = JSON.parse('$:settings');

        document.getElementById("subscribeTopic").value = settings.mqtt.subscribe;
        document.getElementById("publishTopic").value = settings.mqtt.publish;

        for (const sid in settings.rules) {
            const rule = settings.rules[sid];
            const opSelect = document.getElementById(`op_$${sid}`);
            const valInput = document.getElementById(`val_$${sid}`);

            if (opSelect && valInput) {
                opSelect.value = rule.op;
                valInput.value = rule.val;
            }
        }

        function updatePressure() {
            fetch("/pressure-guard-get-data")
                .then(res => res.json())
                .then(data => {
                    document.getElementById("pressureDisplay").innerText =
                        "Last updated: " + (data.timestamp || '--') + " | Pressure: " + data.pressure ?? '--';
                });
        }

        function publishMessage() {
            const topic = document.getElementById("publishTopic").value;
            fetch("/pressure-guard-publish-mqtt", {
                method: "POST",
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'topic='+encodeURIComponent(topic)
            })
            .then(res => res.json())
            .then(data => {
                const modal = document.getElementById("modal");
                const msg = data.success
                    ? 'Message successfully sent to ' + data.topic
                    : 'Error sending message to ' + data.topic + '. Error: ' + data.error;
                document.getElementById("modalMessage").innerText = msg;
                modal.style.display = "block";
            });
        }        

        function saveAllSettings() {
            const sub = document.getElementById("subscribeTopic").value;
            const pub = document.getElementById("publishTopic").value;

            const rules = {};
            master_station_indexes.forEach((sid) => {
                const op = document.getElementById('op_' + sid).value;
                const val = document.getElementById('val_' + sid).value;
                rules[sid] = { op, val };
            });

            fetch("/pressure-guard-save-all-settings", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subscribe: sub,
                    publish: pub,
                    rules: rules
                })
            })
            .then(res => res.json())
            .then(data => {
                const modal = document.getElementById("modal");
                const msg = data.success
                    ? "All settings saved successfully."
                    : 'Error saving settings: ' + data.error;
                document.getElementById("modalMessage").innerText = msg;
                modal.style.display = "block";
            });
        }

        setInterval(updatePressure, 3000);
        updatePressure();
    </script>
</body>
</html>
